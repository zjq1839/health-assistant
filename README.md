# 健康助手 V2（命令行）

一个基于“轻量级规划 + 统一 Agent 协议 + 依赖注入”的本地健康助手，支持记录餐食、记录运动、查询数据、生成报告与获取建议，并内置 RAG 知识检索与多需求解析能力。默认使用本地大模型（Ollama），数据持久化采用 SQLite。

## 你能用它做什么
- 记录：用自然语言记录每日餐食与运动，自动解析餐食组成并计算营养成分，运动支持时长/类型识别
- 查询：按日期/时间范围查询饮食与运动历史，支持统计和趋势类提问
- 报告：按天/周生成健康报告，结合历史记录输出结构化总结
- 建议：结合用户画像与知识库提供饮食/运动/减重等建议
- 多需求：一次输入包含“查询+建议/生成报告”等复合指令，自动分解并有序处理

## 核心特性
- 轻量级规划（规则 → 小模型 → 大模型）：显著降低延迟与成本，并实现高准确率意图识别
- 统一 Agent 协议：统一 run/校验/日志/响应构造，可靠可测、易扩展
- 依赖注入容器：集中管理 Database/LLM/Nutrition/Planner 等服务，解耦实现
- 结构化工具调用：营养与运动计算使用强约束结构化数据，绑定证据来源，结果可解释
- RAG 与多需求解析：知识检索增强建议；复杂多需求输入自动拆解、独立检索与汇总
- SQLite 开箱即用：首次运行自动建表，可选本地营养数据库

## 项目结构（摘要）
- 程序入口：main_v2.py（CLI 主循环、命令解析、状态管理）
- 智能体 agents：饮食/运动/查询/报告/建议、多需求建议、RAG 增强建议
- 核心 core：Agent 协议与工厂、轻量级规划器、RAG 服务、多需求解析、营养服务、服务容器
- 配置与数据：config.py / config.yml、SQLite 数据库、知识库目录
- 脚本与测试：数据库初始化与检查脚本、RAG/多需求测试

## 运行方式（概览）
- 安装依赖（requirements.txt）后直接运行主程序
- 启动后在命令行输入自然语言即可交互
- 内置命令：help（使用指南）、stats（统计信息）、health（健康检查）、reset（重置会话）、quit（退出）

## 重要组件
- LightweightPlanner：三层决策；缓存命中、规则命中、小模型阈值、LLM 兜底；可配置阈值与缓存策略
- BaseAgent/AgentProtocol：统一生命周期与接口，内置错误处理、证据收集、执行日志
- AgentFactory：集中创建与复用 Agent，按名称路由并注入依赖
- EnhancedState/DialogState：对话状态、意图置信度、实体上下文、轮次与 Token 统计
- NutritionService（结构化）：食物数据库、营养计算、运动卡路里计算与校验；返回 NutritionFact 与证据链
- RAGService 与 MultiRequirementRAGService：知识库加载、切分、索引、混合检索与上下文组合
- MultiRequirementParser：多需求识别与拆解，生成执行序列与依赖信息
- ServiceContainer：统一注册与获取 Database/LLM/Nutrition/Planner；健康检查、统计

## 数据与知识库
- 主数据库：SQLite（饮食表、运动表），自动建表
- 营养数据库：本地食物与运动 MET 值，可扩展
- 知识库：支持多格式文档导入与向量化，RAG 用于建议增强与多需求处理

## 配置说明（关键项）
- LLM：模型名称、轻量模型、温度
- 数据库：文件路径
- 知识库：目录路径与嵌入模型
- 检索：返回条数等参数
- 对话：最大消息数、上下文截断与压缩策略
- 缓存：开关、大小、TTL
- 意图识别：阈值、加权、是否启用增强或仅 LLM 模式
- 日志：日志级别与文件

## 交互与可观测性
- CLI 展示：处理状态图标、证据来源摘要、注意事项提示、Token 用量
- 健康检查：数据库、LLM、营养服务、规划器的可用性自检
- 统计信息：对话轮次、意图分布、Agent 使用、数据条目统计

## 扩展指南（无示例代码）
- 新增意图：在枚举中增加类型，并在意图到 Agent 的映射中注册
- 新增 Agent：继承统一协议，声明可处理的意图；在工厂注册并注入所需服务
- 接入新 LLM：实现 LLMService 接口或在容器中注册新的提供方
- 扩展数据源：实现 DatabaseService 接口以支持其他数据库
- 知识库扩展：导入更多文档、优化切分与向量化模型

## 故障排除（常见）
- 本地模型未就绪：请先准备并启动模型服务，或调整配置中的模型名称
- 数据库路径权限：将数据库路径修改到可写目录
- 无法连接 LLM：检查本地服务状态或替换为可用的远程提供方
- RAG 无检索结果：确认知识库目录与索引是否存在

## 许可证
MIT